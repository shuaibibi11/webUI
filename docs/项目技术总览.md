# 项目技术总览（前端 / 后端 / 数据库 / 接口 / 运行逻辑）

## 端口与站点
- 前端（用户端）：`http://localhost:11004/`（或 `http://192.168.3.52:11004/`）
- 管理后台：`http://localhost:11010/admin`（或 `http://192.168.3.52:11010/admin`）
- 后端 API / WebSocket：`http://localhost:3003/`

## 启动与环境
- 后端：在 `backend` 运行 `npm run dev`，读取 `backend/.env`
  - 关键变量：`PORT=3003`、`FRONTEND_URL=http://localhost:11004`、`DATABASE_URL=file:./dev.db`、`JWT_SECRET=...`
- 前端（用户端）：在 `frontend` 运行 `npm run dev`，访问 `11004`
- 管理后台：在 `frontend` 运行 `npm run dev -- --port 11010`，访问 `11010`

## 目录结构与关键文件
- 前端入口与路由：`frontend/src/App.tsx`
  - 用户端/管理端路由、静态条款页、反馈页
- 前端渲染入口：`frontend/src/main.tsx`
- 全局样式：`frontend/src/index.css`
- 登录页：`frontend/src/pages/auth/Login.tsx`
  - 表单校验与强制勾选条款：`frontend/src/pages/auth/Login.tsx:12-20`
  - 登录提交与成功跳转：`frontend/src/pages/auth/Login.tsx:43-75`
- 注册页：`frontend/src/pages/auth/Register.tsx`
  - 强密码校验与实名信息
- 忘记密码页：`frontend/src/pages/auth/PasswordReset.tsx`
  - 两步重置（request + confirm）
- 反馈页：`frontend/src/pages/feedback/Feedback.tsx`
  - 表单提交：`frontend/src/pages/feedback/Feedback.tsx:24-42`
  - 返回上一页按钮：`frontend/src/pages/feedback/Feedback.tsx:45-93`
- 聊天页：`frontend/src/pages/chat/Chat.tsx`
  - 复制/转发剪贴板兼容：`frontend/src/pages/chat/Chat.tsx:224-248`
  - 发送消息与 WS 监听：`frontend/src/pages/chat/Chat.tsx:147-181, 72-107`
- 管理布局与导航：`frontend/src/pages/admin/Layout.tsx`
- 管理模型配置：`frontend/src/pages/admin/Models.tsx`
- 管理账号：`frontend/src/pages/admin/Users.tsx`
  - 重置密码按钮：`frontend/src/pages/admin/Users.tsx:98-101`
- 管理会话详情：`frontend/src/pages/admin/ConversationDetail.tsx`
- 管理审计日志：`frontend/src/pages/admin/Logs.tsx`
- 管理反馈：`frontend/src/pages/admin/Feedbacks.tsx`
- 静态条款页：`frontend/src/pages/static/Terms.tsx`、`frontend/src/pages/static/Privacy.tsx`

- 后端入口：`backend/src/server.ts`
- 应用配置：`backend/src/app.ts`
  - CORS 与认证限流（已放宽）
- 中间件：`backend/src/middleware/auth.ts`（读取 Authorization 或 Cookie，管理员守卫）
- Prisma 客户端：`backend/src/models/prisma.ts`

## 数据库与模型（Prisma）
- 连接：`DATABASE_URL=file:./dev.db`
- 查看与编辑：在 `backend` 运行 `npm run prisma:studio`
- 模型文件：`backend/prisma/schema.prisma`
  - `User`：基础字段 + `role/banned/tokensUsed/passwordResets`
  - `Conversation/Message`：消息含 `promptTokens/completionTokens/totalTokens`
  - `Feedback`：`status/handlerId/handledAt/resolution`
  - `AuditLog`：记录登录/审批/模型变更等
  - `ModelConfig`：`provider/endpoint/apiKey/modelName/tag/protocol/temperature/maxTokens/topP/enabled`
  - `PasswordReset`：密码重置请求（token、过期时间、是否使用）

## 接口总览（REST）
- 用户（`/api/users`）
  - `POST /register`：注册（实名信息、强密码）
  - `POST /login`：支持用户名/邮箱/手机号登录（审批后发 JWT）
  - `GET /info`：获取当前用户信息（认证）
  - `POST /password-reset/request`：发起重置请求（返回 token）
  - `POST /password-reset/confirm`：使用 token 设置新密码
- 会话（`/api/conversations`）
  - `POST /`、`GET /`、`GET /:id`、`PUT /:id`、`DELETE /:id`
- 消息（`/api/messages`）
  - `POST /` 发送消息、`GET /:conversationId` 拉取、`POST /read` 标记已读、`GET /:conversationId/search` 搜索
- 反馈（`/api/feedbacks`）
  - `POST /` 提交反馈（用户端）、`GET /` 列表（认证）
- 管理（`/api/admin`，需 `role=ADMIN`）
  - 用户：`GET /users`、`PUT /users/:id`、`PUT /users/:id/verify`、`PUT /users/:id/ban`、`PUT /users/:id/password`
  - 会话：`GET /users/:id/conversations`、`GET /conversations/:id/messages`、`GET /conversations/:id/search`
  - 模型：`GET/POST/PUT/DELETE /models`
  - 日志：`GET /logs`
  - 反馈：`GET /feedbacks`、`PUT /feedbacks/:id`
- 统一聊天（`/api/chat`）
  - 根据 `ModelConfig` 的 `protocol` 路由到远程模型 API

## 认证与会话逻辑
- 登录成功后返回 JWT 并写入 Cookie（共享）和前端存储（`sessionStorage` 优先，`localStorage` 备份）
- 前端 API 读取令牌优先 `sessionStorage`，保证同浏览器会话隔离
- 管理端入口 `/admin` 解析 JWT payload 的 `role`，非管理员重定向登录

## 站点导航与页面逻辑
- 用户端（11004）：
  - 根地址 `/` → 登录页 `/login`
  - 登录成功 → 聊天页 `/chat`
  - 右下角投诉按钮 → `/feedback`
  - 忘记密码 → `/password-reset`
  - 条款页面 → `/terms` 与 `/privacy`
- 管理端（11010）：
  - 根地址 `/admin/login` → 登录成功进入 `/admin`
  - 侧边菜单：模型配置、账号管理、审计日志、反馈管理

## 模型配置与调用
- 管理页“模型配置”保存 `ModelConfig`，字段：
  - `provider`、`endpoint`、`apiKey?`、`modelName`、`tag`、`protocol`（`openai|ollama|siliconflow|custom`）、`temperature`、`maxTokens`、`topP`、`enabled`
- 后端调用：`backend/src/controllers/chatController.ts`
  - OpenAI：`messages` 输入，解析 `choices[0].message.content` 与 `usage`
  - Ollama：`prompt` 输入，解析 `response/output`，用 `eval_count` 作为总 tokens
  - SiliconFlow：兼容 OpenAI 风格
  - Custom：`choices[0].text` 或 `output/text`
- 消息入库含 tokens，用于统计

## 关键代码映射（引用）
- 登录校验与跳转：`frontend/src/pages/auth/Login.tsx:43-75`
- 忘记密码两步：`backend/src/controllers/userController.ts:158-207`
- 管理重置密码：
  - 接口：`backend/src/controllers/adminController.ts:...adminResetPassword`
  - 前端按钮：`frontend/src/pages/admin/Users.tsx:98-101`
- 复制/转发回退：`frontend/src/pages/chat/Chat.tsx:224-248`
- 反馈提交与返回：`frontend/src/pages/feedback/Feedback.tsx:24-42, 45-93`

## 数据库操作与查看
- 迁移：`npm run prisma:migrate -- --name <name>`
- 生成客户端：`npm run prisma:generate`
- 可视化：`npm run prisma:studio` 打开浏览器操作 SQLite

## 常见修改与配置
- 修改条款链接：更新 `frontend/src/pages/auth/Login.tsx` 中 `/terms` 与 `/privacy`
- 增加协议类型：扩展 `ModelConfig.protocol` 与 `chatController` 分支逻辑
- 放宽认证限流：`backend/src/app.ts` 中 `authLimiter` 配置（已调大）

